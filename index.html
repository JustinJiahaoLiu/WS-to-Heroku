<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSockets Lab - Justin</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <style>
        .container{
            width:400px;
            height: 400px;
            margin: auto;
            border: solid black 1px;
        }
        .messageBox {
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">

    </div>

    <div class="messageBox">
        <input type="text" name="message" value="" placeholder="Enter message here" onkeydown="pressEnter(this)" >
        <button class="btn btn-primary" id="messageBtn" type="button" onclick="sendMsg()">Send</button>
    </div>

    <br/>
    <div class="messageBox" id="gameBox">
        <button class="btn btn-secondary" type="button" onclick="gameStart()">Game Start</button>
    </div>
    <script type="text/javascript">
                
        var HOST = location.origin.replace(/^http/, 'ws')
        var socket = new WebSocket(HOST);
        var name = prompt("What's your name?")


        /*----------------------State Setting-----------------------------*/

        //-----------Game Mode---------------





        socket.onopen = (event) => {
            console.log('Socket Open!');
            socket.send(JSON.stringify({
                type:'name',
                data: name
            }));
            // setTimeout(function () {
            //     socket.send('Hey there');
            // }, 1000)
        };

        socket.onmessage = (event) =>{
            //console.log(event);
            var json = JSON.parse(event.data);
            //console.log(json);

            /*------------Game Mode------------------*/
            if(json.type == "game"){
                if(json.id != 999){
                    //Disable game button!!
                    document.querySelector("#gameBox").style.display = "none";
                    //Set message to game mode
                    document.querySelector("#messageBtn").setAttribute('onclick','gameMsg()');

                    let elem = document.createElement("h3");
                    elem.innerHTML = json.data;
                    document.querySelector(".container").appendChild(elem);
                }else{
                    return; //new user joins under message mode
                }

            }else if(json.type == "gameExit"){
                
                gameExit();  //Turn off game mode

            }else{
            /*------------Message Mode------------------*/
                //when client left
                if(json.data == "left"){
                    let elem = document.createElement("p");
                    elem.innerHTML = json.name + " has left";
                    document.querySelector(".container").appendChild(elem);
                }else{
                    //normal message
                    var elem = document.createElement("li");
                    elem.innerHTML = json.name + ": " + json.data;
                    document.querySelector(".container").appendChild(elem);
                }
            }

        }


        function sendMsg(){

            //Get the message from input
            var msg = document.querySelector("input").value;

            //Add the message to screen locally
            var elem = document.createElement("li");
            elem.innerHTML = "You: " + msg;
            document.querySelector(".container").appendChild(elem);

            //Send the msg to server
            socket.send(JSON.stringify({
                type: 'message',
                data: msg
            }));
            document.querySelector("input").value = "";
            document.querySelector("input").focus();
        }

        function gameMsg(){

            //Get the message from input
            var msg = document.querySelector("input").value;

            //Add the message to screen locally
            var elem = document.createElement("li");
            elem.innerHTML = "You: " + msg;
            document.querySelector(".container").appendChild(elem);

            //Send the msg to server
            socket.send(JSON.stringify({
                type: 'game',
                data: msg
            }));
            document.querySelector("input").value = "";
            document.querySelector("input").focus();
        }

        function gameStart(){
            socket.send(JSON.stringify({
                id: 99,
                type: 'game',
                data: "this-will-activate-game-mode"
            }));
            document.querySelector("#gameBox").style.display = "none";
        }

        function gameExit(){
            document.querySelector("#messageBtn").setAttribute('onclick','sendMsg()');
        }

        function pressEnter(ele) {
            if(event.key === 'Enter') {
                if(document.querySelector("#messageBtn").getAttribute('onclick') == 'gameMsg()'){
                    gameMsg();

                }else{
                    sendMsg();
                }
            }
        }


    </script>
</body>
</html>